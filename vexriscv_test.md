# VexRiscv testing
The VexRiscv test framework uses [Verilator](https://www.veripool.org/verilator/) to perform cycle-accurate simulations of the CPU. This is done with a mix of Scala, C++ and Assembly files. The full suite can be executed with default settings by running the command shown below. This will repeatedly generate CPU variants with random configurations and run all compatible tests.
```
sbt "testOnly vexriscv.TestIndividualFeatures"
```

- [VexRiscv testing](#vexriscv-testing)
  - [Test individual features](#test-individual-features)
    - [File structure](#file-structure)
    - [Standard tests](#standard-tests)
    - [Custom tests](#custom-tests)
    - [VCD output](#vcd-output)
  - [Randomized suite](#randomized-suite)
  - [Debugging](#debugging)

## Test individual features
When developing new CPU features, it's best to follow a test-driven approach. The full randomized test suite is generally too thorough and too slow for this purpose. Instead, the developer should build a *specific* CPU configuration and run a hand-picked selection of tests. 

### File structure
The core test routine is in a 4000+ line file called `src/test/cpp/regression/main.cpp`. This defines a reference CPU model called `RiscvGolden`. Most of the tests are compared against this model to ensure correct operation. It's important to note that this C++ file must be recompiled each time the CPU source files are modified. This is because it uses the C++ header files generated by Verilator to interface directly with the emulated CPU.

The `makefile` in the same directory defines many variables, each of which corresponds to an individual test. These need to be toggled correctly in order to generate the desired subset of tests. For example, the PMP test flags are defined like so in the `makefile`.
```
PMP?=no
ifeq ($(PMP),yes)
    ADDCFLAGS += -CFLAGS -DPMP
endif
```
The first line indicates that the `PMP` variable is disabled by default. The rest of the code checks if that variable is defined as `yes`, and if so, a `PMP` variable is defined and passed to the compiler. In the `main.cpp` file, this will activate the custom PMP test:
```
#ifdef PMP
    redo(REDO,WorkspaceRegression("pmp").loadHex(string(REGRESSION_PATH) + "../raw/pmp/build/pmp.hex")->bootAt(0x80000000u)->run(10e3););
#endif
```
To run *only* the PMP test on a specific CPU configuration, we can do the following (from the repository root directory). 
```
make -C src/test/cpp/raw/pmp
sbt "runMain vexriscv.demo.GenSecure"
make -C src/test/cpp/regression clean run CSR_SKIP_TEST=yes CSR=yes MMU=no PMP=yes DHRYSTONE=no ISA_TEST=no
```

### Standard tests

### Custom tests

### VCD output

## Randomized suite

## Debugging